require 'rails_helper'

describe SynchronizeOrdersWithRedmineIssues do
  it "does nothing when no issues are given" do
    order = FactoryGirl.create :order
    order_event = FactoryGirl.create :order_event, :name => "delivery_manual", :data => "13377", :order => order

    issue_repository = RedmineIssueRepository.new
    issue_repository.add_issues([])

    SynchronizeOrdersWithRedmineIssues.new(issue_repository).call

    expect(order.order_events.length).to eq(1)
  end

  it "does something when an issues is given" do
    order = FactoryGirl.create :order
    order_event = FactoryGirl.create :order_event, :name => "delivery_manual", :data => "13377", :order => order

    issue_repository = RedmineIssueRepository.new
    issue_repository.add_issues([{"issue"=>{"id"=>13377, "project"=>{"id"=>5, "name"=>"Article Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 1 requests \"Graphene-Metal Oxide Hybrid Nanostructured Materials for Electrocatalytic Sensing and Sustainable Energy Storage \"", "description"=>"User \"Anonymous User 1\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXX&tab=1 ( CWIS: XXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20journal%20article%20request&body=%22Graphene-Metal%20Oxide%20Hybrid%20Nanostructured%20Materials%20for%20Electrocatalytic%20Sensing%20and%20Sustainable%20Energy%20Storage%20%22%20by%20Arnab%20Halder,%20Minwei%20Zhang,%20Qijin%20Chi ) requests the following:\r\n\r\n<pre>\r\n== Article ==========\r\n\r\nTitle:\r\n   Graphene-Metal Oxide Hybrid Nanostructured Materials for Electrocatalytic Sensing and Sustainable Energy Storage \r\nAuthor:\r\n   Arnab Halder, Minwei Zhang, Qijin Chi\r\n\r\n== Journal ==========\r\n\r\nTitle:\r\n   Reviews in Advanced Sciences and Engineering\r\nIssn:\r\n   2157-9121 \r\nVolume:\r\n   5\r\nYear:\r\n   2016\r\nPages:\r\n   4-31\r\n\r\n== Notes from user ==========\r\n\r\n   .\r\n   Many thanks for your support.\r\n\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>Institut for Kemi\r\nAtt: Anonymous User 1\r\nBygning 000, Rum 000\r\nDK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-07-15", "due_date"=>"2017-01-15", "done_ratio"=>0, "spent_hours"=>0.0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Chemistry"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"TIB Hannover"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-07-15T07:28:55Z", "updated_on"=>"2016-07-19T13:17:01Z", "journals"=>[{"id"=>20940, "user"=>{"id"=>12, "name"=>"Anonymous User 2"}, "notes"=>"GI154127482816", "created_on"=>"2016-07-15T07:53:38Z", "details"=>[{"property"=>"attr", "name"=>"status_id", "old_value"=>"1", "new_value"=>"2"}, {"property"=>"cf", "name"=>"2", "old_value"=>"", "new_value"=>"TIB Hannover"}]}, {"id"=>20984, "user"=>{"id"=>15, "name"=>"Anonymous User 3"}, "notes"=>"TIB: unfilled. Not yet receeived. re-order some times later ", "created_on"=>"2016-07-19T13:17:01Z", "details"=>[]}]}}])

    SynchronizeOrdersWithRedmineIssues.new(issue_repository).call

    an_order_event = order.order_events.select { |oe| oe.name == "note" && oe.redmine_issue_id == "13377" && oe.redmine_journal_entry_id == "20940" }.first
    expect(an_order_event).not_to be_nil
    expect(an_order_event.created_at.to_s).to eq("2016-07-15 09:53:38 +0200")
    expect(an_order_event.data).to eq("GI154127482816")
  end

  it "is idempotent" do
    order = FactoryGirl.create :order
    order_event = FactoryGirl.create :order_event, :name => "delivery_manual", :data => "13377", :order => order

    issue_repository = RedmineIssueRepository.new
    issue_repository.add_issues([{"issue"=>{"id"=>13377, "project"=>{"id"=>5, "name"=>"Article Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 1 requests \"Graphene-Metal Oxide Hybrid Nanostructured Materials for Electrocatalytic Sensing and Sustainable Energy Storage \"", "description"=>"User \"Anonymous User 1\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXX&tab=1 ( CWIS: XXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20journal%20article%20request&body=%22Graphene-Metal%20Oxide%20Hybrid%20Nanostructured%20Materials%20for%20Electrocatalytic%20Sensing%20and%20Sustainable%20Energy%20Storage%20%22%20by%20Arnab%20Halder,%20Minwei%20Zhang,%20Qijin%20Chi ) requests the following:\r\n\r\n<pre>\r\n== Article ==========\r\n\r\nTitle:\r\n   Graphene-Metal Oxide Hybrid Nanostructured Materials for Electrocatalytic Sensing and Sustainable Energy Storage \r\nAuthor:\r\n   Arnab Halder, Minwei Zhang, Qijin Chi\r\n\r\n== Journal ==========\r\n\r\nTitle:\r\n   Reviews in Advanced Sciences and Engineering\r\nIssn:\r\n   2157-9121 \r\nVolume:\r\n   5\r\nYear:\r\n   2016\r\nPages:\r\n   4-31\r\n\r\n== Notes from user ==========\r\n\r\n   .\r\n   Many thanks for your support.\r\n\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>Institut for Kemi\r\nAtt: Anonymous User 1\r\nBygning 000, Rum 000\r\nDK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-07-15", "due_date"=>"2017-01-15", "done_ratio"=>0, "spent_hours"=>0.0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Chemistry"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"TIB Hannover"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-07-15T07:28:55Z", "updated_on"=>"2016-07-19T13:17:01Z", "journals"=>[{"id"=>20940, "user"=>{"id"=>12, "name"=>"Anonymous User 2"}, "notes"=>"GI154127482816", "created_on"=>"2016-07-15T07:53:38Z", "details"=>[{"property"=>"attr", "name"=>"status_id", "old_value"=>"1", "new_value"=>"2"}, {"property"=>"cf", "name"=>"2", "old_value"=>"", "new_value"=>"TIB Hannover"}]}, {"id"=>20984, "user"=>{"id"=>15, "name"=>"Anonymous User 3"}, "notes"=>"TIB: unfilled. Not yet receeived. re-order some times later ", "created_on"=>"2016-07-19T13:17:01Z", "details"=>[]}]}}])

    SynchronizeOrdersWithRedmineIssues.new(issue_repository).call
    expect(order.order_events.select { |oe| oe.name == "note" && oe.redmine_issue_id == "13377" && oe.redmine_journal_entry_id == "20940" }.length).to eq(1)

    SynchronizeOrdersWithRedmineIssues.new(issue_repository).call
    expect(order.order_events.select { |oe| oe.name == "note" && oe.redmine_issue_id == "13377" && oe.redmine_journal_entry_id == "20940" }.length).to eq(1)
  end

  it "does not blow up when it cannot find an Order matching an issue" do
    issue_repository = RedmineIssueRepository.new
    issue_repository.add_issues([{"issue"=>{"id"=>13377, "project"=>{"id"=>5, "name"=>"Article Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 1 requests \"Graphene-Metal Oxide Hybrid Nanostructured Materials for Electrocatalytic Sensing and Sustainable Energy Storage \"", "description"=>"User \"Anonymous User 1\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXX&tab=1 ( CWIS: XXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20journal%20article%20request&body=%22Graphene-Metal%20Oxide%20Hybrid%20Nanostructured%20Materials%20for%20Electrocatalytic%20Sensing%20and%20Sustainable%20Energy%20Storage%20%22%20by%20Arnab%20Halder,%20Minwei%20Zhang,%20Qijin%20Chi ) requests the following:\r\n\r\n<pre>\r\n== Article ==========\r\n\r\nTitle:\r\n   Graphene-Metal Oxide Hybrid Nanostructured Materials for Electrocatalytic Sensing and Sustainable Energy Storage \r\nAuthor:\r\n   Arnab Halder, Minwei Zhang, Qijin Chi\r\n\r\n== Journal ==========\r\n\r\nTitle:\r\n   Reviews in Advanced Sciences and Engineering\r\nIssn:\r\n   2157-9121 \r\nVolume:\r\n   5\r\nYear:\r\n   2016\r\nPages:\r\n   4-31\r\n\r\n== Notes from user ==========\r\n\r\n   .\r\n   Many thanks for your support.\r\n\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>Institut for Kemi\r\nAtt: Anonymous User 1\r\nBygning 000, Rum 000\r\nDK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-07-15", "due_date"=>"2017-01-15", "done_ratio"=>0, "spent_hours"=>0.0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Chemistry"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"TIB Hannover"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-07-15T07:28:55Z", "updated_on"=>"2016-07-19T13:17:01Z", "journals"=>[{"id"=>20940, "user"=>{"id"=>12, "name"=>"Anonymous User 2"}, "notes"=>"GI154127482816", "created_on"=>"2016-07-15T07:53:38Z", "details"=>[{"property"=>"attr", "name"=>"status_id", "old_value"=>"1", "new_value"=>"2"}, {"property"=>"cf", "name"=>"2", "old_value"=>"", "new_value"=>"TIB Hannover"}]}, {"id"=>20984, "user"=>{"id"=>15, "name"=>"Anonymous User 3"}, "notes"=>"TIB: unfilled. Not yet receeived. re-order some times later ", "created_on"=>"2016-07-19T13:17:01Z", "details"=>[]}]}}])

    SynchronizeOrdersWithRedmineIssues.new(issue_repository).call
  end
end

describe LibrarySupport do
  subject do
    LibrarySupport.new
  end

  before(:each) do
    first_issues_call_done = false

    allow_any_instance_of(Redmine).to receive(:send_get_request) do |redmine, path, params|
      if path == ("issues")
        next {"issues"=>[]} if first_issues_call_done
        first_issues_call_done = true
        next {"issues"=>[{"id"=>10647, "project"=>{"id"=>7, "name"=>"Book Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 5 requests \"Embryo rescue for interspecific hybrids in Vicia\"", "description"=>"User \"Anonymous User 5\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXXXX&tab=1 ( CWIS: XXXXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20book%20request&body=%22Embryo%20rescue%20for%20interspecific%20hybrids%20in%20Vicia%22%20by%20Stewart,%20M.%20H. ) requests the following:\r\n\r\n<pre>\r\n== Book ==========\r\n\r\nTitle:\r\n   Embryo rescue for interspecific hybrids in Vicia\r\nYear:\r\n   1988 \r\nAuthor:\r\n   Stewart, M. H.\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>Institut for Matematik og Computer Science\r\nAtt: Anonymous User 5\r\nBygning 0000, Rum 000\r\nAsmussens Allé\r\n2800\r\nKgs. Lyngby\r\nDANMARK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-02-08", "done_ratio"=>0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Compute"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"British Library"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>8, "name"=>"ISBN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-02-08T18:02:14Z", "updated_on"=>"2016-02-15T09:44:03Z"}, {"id"=>10497, "project"=>{"id"=>5, "name"=>"Article Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 6 requests \"Using Critical Realism to Explain Strategic Information Systems Planning\"", "description"=>"User \"Anonymous User 6\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXXX&tab=1 ( CWIS: XXXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20journal%20article%20request&body=%22Using%20Critical%20Realism%20to%20Explain%20Strategic%20Information%20Systems%20Planning%22%20by%20PAUL%20MORTON ) requests the following:\r\n\r\n<pre>\r\n== Article ==========\r\n\r\nTitle:\r\n   Using Critical Realism to Explain Strategic Information Systems Planning\r\nAuthor:\r\n   PAUL MORTON\r\n\r\n== Journal ==========\r\n\r\nTitle:\r\n   Journal of Information Technology Theory and Application\r\nVolume:\r\n   8\r\nIssue:\r\n   1\r\nYear:\r\n   2006\r\nPages:\r\n   1-20\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>DTU Management Engineering\r\nAtt: Anonymous User 6\r\nBygning 000, Rum 0000\r\nProduktionstorvet\r\n2800\r\nKgs. Lyngby\r\nDANMARK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-02-03", "done_ratio"=>0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Management Engineering"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"TIB Hannover"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-02-03T20:59:57Z", "updated_on"=>"2016-03-02T13:06:11Z"}, {"id"=>11577, "project"=>{"id"=>5, "name"=>"Article Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 4 requests \"DIN 51701-3 Sampling of solid fuels - sample preparation\"", "description"=>"User \"Anonymous User 4\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXXX&tab=1 ( CWIS: XXXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20journal%20article%20request&body=%22DIN%2051701-3%20Sampling%20of%20solid%20fuels%20-%20sample%20preparation%22%20by%20CEN ) requests the following:\r\n\r\n<pre>\r\n== Article ==========\r\n\r\nTitle:\r\n   DIN 51701-3 Sampling of solid fuels - sample preparation\r\nAuthor:\r\n   CEN\r\n\r\n== Journal ==========\r\n\r\nTitle:\r\n   CEN\r\nVolume:\r\n   del 3\r\nYear:\r\n   ikke kendt\r\nPages:\r\n   ikke kendt\r\n\r\n== Notes from user ==========\r\n\r\n   .\r\n\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>Fødevareinstituttet\r\nAtt: Anonymous User 4\r\nBygning 00, Rum 0000\r\nMørkhøj Bygade 19\r\n2860\r\nSøborg\r\nDANMARK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-03-21", "done_ratio"=>0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Food"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"TIB Hannover"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-03-21T10:24:53Z", "updated_on"=>"2016-04-15T09:16:51Z"}], "total_count"=>1005, "offset"=>500, "limit"=>100}
      end
      if path.include?("issues/10647")
        next {"issue"=>{"id"=>10647, "project"=>{"id"=>7, "name"=>"Book Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 5 requests \"Embryo rescue for interspecific hybrids in Vicia\"", "description"=>"User \"Anonymous User 5\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXXXX&tab=1 ( CWIS: XXXXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20book%20request&body=%22Embryo%20rescue%20for%20interspecific%20hybrids%20in%20Vicia%22%20by%20Stewart,%20M.%20H. ) requests the following:\r\n\r\n<pre>\r\n== Book ==========\r\n\r\nTitle:\r\n   Embryo rescue for interspecific hybrids in Vicia\r\nYear:\r\n   1988 \r\nAuthor:\r\n   Stewart, M. H.\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>Institut for Matematik og Computer Science\r\nAtt: Anonymous User 5\r\nBygning 0000, Rum 000\r\nAsmussens Allé\r\n2800\r\nKgs. Lyngby\r\nDANMARK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-02-08", "done_ratio"=>0, "spent_hours"=>0.0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Compute"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"British Library"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>8, "name"=>"ISBN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-02-08T18:02:14Z", "updated_on"=>"2016-02-15T09:44:03Z", "journals"=>[{"id"=>16380, "user"=>{"id"=>15, "name"=>"Anonymous User 3"}, "notes"=>"skal abskaffes via Ethos Thesis ", "created_on"=>"2016-02-10T13:09:30Z", "details"=>[{"property"=>"attr", "name"=>"status_id", "old_value"=>"1", "new_value"=>"4"}, {"property"=>"cf", "name"=>"2", "old_value"=>"", "new_value"=>"British Library"}]}, {"id"=>16385, "user"=>{"id"=>15, "name"=>"Anonymous User 3"}, "notes"=>"haves ETHOS til 45 GBP skal betales med kreditkort og ikke via vore deposit account hos BLL checker om den kan skaffes via anden lev.   ", "created_on"=>"2016-02-10T13:40:50Z", "details"=>[]}, {"id"=>16423, "user"=>{"id"=>15, "name"=>"Anonymous User 3"}, "notes"=>"BLL via OCLC", "created_on"=>"2016-02-12T09:01:08Z", "details"=>[{"property"=>"attr", "name"=>"status_id", "old_value"=>"4", "new_value"=>"2"}, {"property"=>"cf", "name"=>"2", "old_value"=>"British Library", "new_value"=>"OCLC"}]}, {"id"=>16501, "user"=>{"id"=>15, "name"=>"Anonymous User 3"}, "notes"=>"Minus BLL via OCLC skal bestilles via Ethos men prøver først University of Reasing direkte ", "created_on"=>"2016-02-15T09:44:03Z", "details"=>[{"property"=>"cf", "name"=>"2", "old_value"=>"OCLC", "new_value"=>"British Library"}]}]}}
      end
      if path.include?("issues/10497")
        next {"issue"=>{"id"=>10497, "project"=>{"id"=>5, "name"=>"Article Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 6 requests \"Using Critical Realism to Explain Strategic Information Systems Planning\"", "description"=>"User \"Anonymous User 6\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXXX&tab=1 ( CWIS: XXXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20journal%20article%20request&body=%22Using%20Critical%20Realism%20to%20Explain%20Strategic%20Information%20Systems%20Planning%22%20by%20PAUL%20MORTON ) requests the following:\r\n\r\n<pre>\r\n== Article ==========\r\n\r\nTitle:\r\n   Using Critical Realism to Explain Strategic Information Systems Planning\r\nAuthor:\r\n   PAUL MORTON\r\n\r\n== Journal ==========\r\n\r\nTitle:\r\n   Journal of Information Technology Theory and Application\r\nVolume:\r\n   8\r\nIssue:\r\n   1\r\nYear:\r\n   2006\r\nPages:\r\n   1-20\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>DTU Management Engineering\r\nAtt: Anonymous User 6\r\nBygning 000, Rum 0000\r\nProduktionstorvet\r\n2800\r\nKgs. Lyngby\r\nDANMARK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-02-03", "done_ratio"=>0, "spent_hours"=>0.0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Management Engineering"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"TIB Hannover"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-02-03T20:59:57Z", "updated_on"=>"2016-03-02T13:06:11Z", "journals"=>[{"id"=>17017, "user"=>{"id"=>11, "name"=>"Anonymous User 8"}, "notes"=>"TIBSUBITO:GI507112810150", "created_on"=>"2016-03-02T13:06:11Z", "details"=>[{"property"=>"attr", "name"=>"status_id", "old_value"=>"1", "new_value"=>"2"}, {"property"=>"cf", "name"=>"2", "old_value"=>"", "new_value"=>"TIB Hannover"}]}]}}
      end
      if path.include?("issues/11577")
        next {"issue"=>{"id"=>11577, "project"=>{"id"=>5, "name"=>"Article Requests"}, "tracker"=>{"id"=>3, "name"=>"Support"}, "status"=>{"id"=>2, "name"=>"Requested/inprocess"}, "priority"=>{"id"=>4, "name"=>"Normal"}, "author"=>{"id"=>26, "name"=>"Rest API"}, "subject"=>"Anonymous User 4 requests \"DIN 51701-3 Sampling of solid fuels - sample preparation\"", "description"=>"User \"Anonymous User 4\":http://www.dtu.dk/Service/Telefonbog/Person?id=XXXXX&tab=1 ( CWIS: XXXXX; \"Send email\":mailto:nomail@localhost?reply-to=bibliotek@dtu.dk&subject=Regarding%20your%20journal%20article%20request&body=%22DIN%2051701-3%20Sampling%20of%20solid%20fuels%20-%20sample%20preparation%22%20by%20CEN ) requests the following:\r\n\r\n<pre>\r\n== Article ==========\r\n\r\nTitle:\r\n   DIN 51701-3 Sampling of solid fuels - sample preparation\r\nAuthor:\r\n   CEN\r\n\r\n== Journal ==========\r\n\r\nTitle:\r\n   CEN\r\nVolume:\r\n   del 3\r\nYear:\r\n   ikke kendt\r\nPages:\r\n   ikke kendt\r\n\r\n== Notes from user ==========\r\n\r\n   .\r\n\r\n</pre>\r\n\r\nSend by DTU Internal Mail to\r\n\r\n<pre>Fødevareinstituttet\r\nAtt: Anonymous User 4\r\nBygning 00, Rum 0000\r\nMørkhøj Bygade 19\r\n2860\r\nSøborg\r\nDANMARK</pre>\r\n\r\n\"View order in DTU Findit\":http://findit.dtu.dk/en/orders/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/status", "start_date"=>"2016-03-21", "done_ratio"=>0, "spent_hours"=>0.0, "custom_fields"=>[{"id"=>1, "name"=>"DTU Unit", "value"=>"DTU Food"}, {"id"=>2, "name"=>"Document Supplier", "value"=>"TIB Hannover"}, {"id"=>5, "name"=>"Delivery Request Resolved As", "value"=>""}, {"id"=>6, "name"=>"ISSN", "value"=>""}, {"id"=>7, "name"=>"Publisher", "value"=>""}, {"id"=>15, "name"=>"Reordered", "value"=>"No"}], "created_on"=>"2016-03-21T10:24:53Z", "updated_on"=>"2016-04-15T09:16:51Z", "journals"=>[{"id"=>18520, "user"=>{"id"=>10, "name"=>"Anonymous User 7"}, "notes"=>"", "created_on"=>"2016-04-15T09:16:51Z", "details"=>[{"property"=>"attr", "name"=>"status_id", "old_value"=>"1", "new_value"=>"2"}, {"property"=>"cf", "name"=>"2", "old_value"=>"", "new_value"=>"TIB Hannover"}]}]}}
      end
    end
  end

  it "gets order events from redmine" do
    order_events_from_redmine = subject.fetch_issues_from_redmine
    expect(order_events_from_redmine).not_to eq []
    expect(order_events_from_redmine.collect { |event| event["issue"]["id"] }.sort).to eq([10497, 10647, 11577].sort)
    expect(order_events_from_redmine.collect { |event| event["issue"]["journals"] }.reject { |journals| journals.nil? }).not_to eq([])
  end

  it "synchronizes order events based on redmine issue" do
    order = FactoryGirl.create :order, :id => 1455024
    order_event = FactoryGirl.create :order_event, :name => "delivery_manual", :data => "10497", :order => order

    expect(order.order_events.length).to eq(1)

    subject.synchronize_order_events_from_redmine

    synchronized_order = Order.where(:id => 1455024).first

    expect(synchronized_order.order_events.length).not_to eq(1)
    expect(synchronized_order.order_events.any? { |order_event| order_event.name == "note" && order_event.data == "TIBSUBITO:GI507112810150" && order_event.redmine_issue_id == "10497" && order_event.redmine_journal_entry_id == "17017" }).to eq(true)
    expect(synchronized_order.order_events.any? { |order_event| order_event.name == "requested_or_inprocess" && order_event.redmine_issue_id == "10497" && order_event.redmine_journal_entry_id == "17017" }).to eq(true)
    expect(synchronized_order.order_events.any? { |order_event| order_event.name == "document_supplier_changed" && order_event.data == "TIB Hannover" && order_event.redmine_issue_id == "10497" && order_event.redmine_journal_entry_id == "17017" }).to eq(true)
  end
end
